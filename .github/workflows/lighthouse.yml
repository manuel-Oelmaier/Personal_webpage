name: Lighthouse & Deploy
on:
  push:
    branches: [main]
  workflow_dispatch:
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build_audit_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Install Dependencies
        run: pnpm install

      - name: Build Astro Site
        run: pnpm run build

      # Audit the static output in ./dist
      - name: Lighthouse Audit
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
          staticDistDir: './dist'

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Update README with scores
        run: |
          REPORT_PATH=$(ls .lighthouseci/lhr-*.json | head -n 1)
          PERF=$(node -e "console.log(Math.round(require('./$REPORT_PATH').categories.performance.score * 100))")
          ACC=$(node -e "console.log(Math.round(require('./$REPORT_PATH').categories.accessibility.score * 100))")
          BP=$(node -e "console.log(Math.round(require('./$REPORT_PATH').categories['best-practices'].score * 100))")
          SEO=$(node -e "console.log(Math.round(require('./$REPORT_PATH').categories.seo.score * 100))")
          DATE=$(date +%Y-%m-%d)
          
          sed -i "/| \*\*Performance\*\* |/c\| **Performance** | $PERF |" README.md
          sed -i "/| \*\*Accessibility\*\* |/c\| **Accessibility** | $ACC |" README.md
          sed -i "/| \*\*Best Practices\*\* |/c\| **Best Practices** | $BP |" README.md
          sed -i "/| \*\*SEO\*\* |/c\| **SEO** | $SEO |" README.md
          sed -i "/\*Last dynamic audit:/c\*Last dynamic audit: $DATE via GitHub Actions.*" README.md

      - name: Commit and Push changes
        run: |
          git config --global user.name "Nova-Architect"
          git config --global user.email "nova@manueloelmaier.de"
          git add README.md
          git commit -m "docs: dynamic lighthouse score update [skip ci]" || echo "No changes to commit"
          git push
