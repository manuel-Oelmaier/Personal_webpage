name: Lint and Fix

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  eslint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: Personal_webpage/pnpm-lock.yaml

      - name: Install dependencies
        run: |
          cd Personal_webpage
          pnpm add -D eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin eslint-plugin-astro astro-eslint-parser

      - name: Run ESLint and Fix
        run: |
          cd Personal_webpage
          # Initialize eslint config if it doesn't exist (using a basic one for Astro/TS)
          if [ ! -f .eslintrc.json ] && [ ! -f eslint.config.js ]; then
            echo '{
              "extends": [
                "eslint:recommended",
                "plugin:@typescript-eslint/recommended",
                "plugin:astro/recommended"
              ],
              "parser": "@typescript-eslint/parser",
              "plugins": ["@typescript-eslint"],
              "overrides": [
                {
                  "files": ["*.astro"],
                  "parser": "astro-eslint-parser",
                  "parserOptions": {
                    "parser": "@typescript-eslint/parser",
                    "extraFileExtensions": [".astro"]
                  }
                }
              ],
              "env": {
                "browser": true,
                "node": true
              }
            }' > .eslintrc.json
          fi
          npx eslint . --fix || true

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: auto-fix linting issues via ESLint"
          file_pattern: 'Personal_webpage/**'
